
#include "test.h"

/*This is register when request is send and when the corresponding anser is received the deamon calls this function and passes the answer message 'msg' for this function to process. and it also passes the data 'data' which was registered when the request was sent.
*/
void test_ans_cb(void * data, struct msg ** msg){

	unsigned32  result_code = 0;
	unsigned32 exp_result_code = 0;
	integer32 err_diag = 0;
	unsigned32 vend_id = 0;
	diameterid * origin = NULL;
	char * code_str = NULL;

	if(!msg){
		
		fprintf(stderr,"Error : Answer received with emtyp message.\n");
		return;
	}
		
	/*extract origin host name*/
	SS_CHECK( ss_get_origin_host(*msg, &origin), "", "Failed to extract origin host from answer message.\n");
	fprintf(stdout, "Answer received from %s\n", (char *)origin);

	/*extract result-code*/
	SS_WCHECK( ss_get_result_code(*msg, &result_code), "", "Failed to extract result code from answer message.\n", NULL);

	/*change result code to its string value*/
	code_2_str((int)result_code, &code_str);
	if(code_str){

		fprintf(stdout, "OK : Result code %s\n", code_str);
		free(code_str);
		code_str = NULL;
	}

	/*extract experimental result child avp values*/
	if( get_experimental_result(*msg, &vend_id, &exp_result_code) == 0){
		
		/*change result code to its string value*/
		code_2_str((int)exp_result_code, &code_str);

		if(code_str){

			fprintf(stdout, "OK : Experimetal Result:  exp-result-code - %s   vendor_id - %d\n", code_str, vend_id);
			free(code_str);
			code_str = NULL;
		}
	}

	/*extract Error diagnostic from message*/
	SS_WCHECK( ss_get_error_diagnostic(*msg, &err_diag), "Error-Diagnostic value extracted.\n", "Failed to extract error diagnostic.\n", NULL);

	/*change result code to its string value*/
	code_2_str(err_diag, &code_str);

	if(code_str){

		fprintf(stdout, "OK : Error Diagnostic  %s\n", code_str);
		free(code_str);
		code_str = NULL;
	}

	/* Free the message */
	fd_msg_free(*msg);
	*msg = NULL;
}
